const newsSources=[{name:"Nintendo Life",homepage:"https://www.nintendolife.com/",url:"https://www.nintendolife.com/feeds/latest",color:"#ff4d5a"},{name:"Nintendo World Report",homepage:"https://www.nintendoworldreport.com/",url:"https://www.nintendoworldreport.com/rss",color:"#4db8e8"},{name:"Pure Nintendo",homepage:"https://www.purenintendo.com/",url:"https://www.purenintendo.com/feed",color:"#ff8c42"},{name:"My Nintendo News",homepage:"https://mynintendonews.com/",url:"https://mynintendonews.com/feed/",color:"#00c2ff"},{name:"GoNintendo",url:"https://gonintendo.com/feeds/story.xml",color:"#e96b67"},{name:"Nintendo Everything",homepage:"https://nintendoeverything.com/",url:"https://nintendoeverything.com/feed",color:"#00bff3"},{name:"IGN Nintendo",homepage:"https://www.ign.com/",url:"https://www.ign.com/rss/v2/articles/feed?channel=nintendo",color:"#FFFFFF"},{name:"Nintendo Insider",homepage:"https://www.nintendo-insider.com/",url:"https://nintendo-insider.com/feed",color:"#ff4d5a"},{name:"Nintendo Fuse",homepage:"https://nintendofuse.com/",url:"https://nintendofuse.com/rss",color:"#78c3fb"},{name:"Nintendo Soup",homepage:"https://nintendosoup.com/",url:"https://nintendosoup.com/feed",color:"#ff4d5a"},{name:"Nintendojo",homepage:"https://www.nintendojo.com/",url:"https://www.nintendojo.com/feed",color:"#ff5c7c"},{name:"Nintendo Wire",homepage:"https://nintendowire.com/",url:"https://nintendowire.com/feed",color:"#ffcd00"}],CORS_PROXIES=["https://api.codetabs.com/v1/proxy?quest=","https://corsproxy.io/?","https://api.allorigins.win/get?url=","https://cors-anywhere.herokuapp.com/","https://thingproxy.freeboard.io/fetch/"],feedCache=new Map,CACHE_DURATION=3e5;async function fetchRSSFeed(e){const t=e.url,n=feedCache.get(t);if(n&&Date.now()-n.timestamp<3e5)return n.data;let r=null;for(let n=0;n<CORS_PROXIES.length;n++)try{const r=`${CORS_PROXIES[n]}${encodeURIComponent(e.url)}`,o=new AbortController,i=setTimeout(()=>o.abort(),1e4),a=await fetch(r,{signal:o.signal,headers:{Accept:"application/rss+xml, application/xml, text/xml, */*",Origin:window.location.origin||"https://nintendonewsnetwork.com"}});if(clearTimeout(i),!a.ok)throw new Error(`HTTP error! status: ${a.status}`);let l,c;if(CORS_PROXIES[n].includes("allorigins"))try{l=await a.json(),c=l.contents||l.data}catch(e){c=await a.text()}else CORS_PROXIES[n].includes("codetabs")||CORS_PROXIES[n].includes("corsproxy.io"),c=await a.text();if(!c||"string"!=typeof c)throw new Error("Invalid response: no content received");if(c.startsWith("data:application/rss+xml")||c.startsWith("data:text/xml")||c.startsWith("data:application/xml")){const e=c.split(",")[1];if(e)try{c=atob(e)}catch(e){throw new Error("Failed to decode base64 content")}}const s=new DOMParser,d=s.parseFromString(c,"text/xml"),u=d.querySelector("parsererror");if(u){throw null!==s.parseFromString(c,"text/html").querySelector("html")?new Error("Received HTML content instead of RSS/XML feed"):new Error(`XML parsing failed: ${u.textContent}`)}let m=d.querySelectorAll("item"),g=!1;0===m.length&&(m=d.querySelectorAll("entry"),g=!0),m.length;const p=[];m.forEach((e,t)=>{if(t<10){let t,n,r,o,i;if(g){t=e.querySelector("title")?.textContent?.trim();const a=e.querySelector('link[rel="alternate"]')||e.querySelector('link[type="text/html"]')||e.querySelector("link");n=a?.getAttribute("href")||a?.textContent?.trim(),r=e.querySelector("summary")?.textContent?.trim()||e.querySelector("content")?.textContent?.trim(),o=e.querySelector("published")?.textContent?.trim()||e.querySelector("updated")?.textContent?.trim(),i=extractImageUrl(e,r,!0)}else t=e.querySelector("title")?.textContent?.trim(),n=e.querySelector("link")?.textContent?.trim(),r=e.querySelector("description")?.textContent?.trim(),o=e.querySelector("pubDate")?.textContent?.trim(),i=extractImageUrl(e,r,!1);t&&n&&p.push({title:fixTextEncoding(t),link:n,description:cleanDescription(r),pubDate:formatDate(o),rawDate:o,imageUrl:i})}});const h={source:e,articles:p,error:null};return feedCache.set(t,{data:h,timestamp:Date.now()}),h}catch(e){r=e}return{source:e,articles:[],error:"file:"===window.location.protocol?`${e.name}: CORS blocked (try hosting on a web server)`:`${e.name}: All proxy servers failed - ${r?.message||"Unknown error"}`}}function extractImageUrl(e,t,n){let r=null;try{if(r=n?e.querySelector('link[rel="enclosure"]')?.getAttribute("href")||e.querySelector('content[type="html"]')?.textContent:e.querySelector('enclosure[type^="image"]')?.getAttribute("url")||e.querySelector("enclosure")?.getAttribute("url")||e.querySelector("media\\:thumbnail")?.getAttribute("url")||e.querySelector("thumbnail")?.getAttribute("url")||e.querySelector('media\\:content[type^="image"]')?.getAttribute("url")||e.querySelector("media\\:content")?.getAttribute("url")||e.querySelector("image")?.textContent||e.querySelector("media\\:group media\\:thumbnail")?.getAttribute("url")||e.querySelector("wp\\:post_thumbnail")?.textContent||e.querySelector("wp\\:featuredImage")?.textContent||e.querySelector("ign\\:image")?.getAttribute("url")||e.querySelector("ign\\:thumbnail")?.getAttribute("url")||e.querySelector("feedburner\\:origEnclosureLink")?.textContent||e.querySelector("itunes\\:image")?.getAttribute("href")||e.querySelector("googleplay\\:image")?.getAttribute("href")||e.querySelector("yoast\\:image")?.textContent||e.querySelector("og\\:image")?.getAttribute("content"),!r){const t=[e.querySelector("content\\:encoded")?.textContent,e.querySelector("content")?.textContent,e.querySelector("summary")?.textContent,e.querySelector("description")?.textContent].filter(e=>e&&e.trim().length>0);for(let e of t){if(r)break;try{const t=document.createElement("div");t.innerHTML=e;const n=["img.wp-post-image","img.attachment-large","img.featured","img[width][height]",'img[src*="featured"]','img[src*="banner"]','img[src*="hero"]','img:not([src*="avatar"]):not([src*="icon"]):not([src*="logo"])',"img"];for(let e of n){const n=t.querySelector(e);if(n){const e=n.getAttribute("src")||n.getAttribute("data-src")||n.getAttribute("data-lazy-src");if(e&&e.trim()){const t=n.getAttribute("width"),o=n.getAttribute("height");if(t&&o&&(parseInt(t)<100||parseInt(o)<100))continue;r=e.trim();break}}}if(!r){const t=/https?:\/\/[^\s"'<>]*\.(?:jpg|jpeg|png|gif|webp)(?:\?[^\s"'<>]*)?/gi,n=e.match(t);if(n&&n.length>0){const e=n.filter(e=>!e.includes("thumbnail")&&!e.includes("avatar")&&!e.includes("icon")&&!e.includes("logo")&&(e.includes("large")||e.includes("medium")||e.includes("featured")||!e.includes("small")));r=e.length>0?e[0]:n[0]}}}catch(e){continue}}}if(!r&&t){const e=document.createElement("div");e.innerHTML=t;let n=e.querySelector("img.wp-post-image")||e.querySelector("img.attachment-large")||e.querySelector("img.featured")||e.querySelector("img[width]")||e.querySelector("img");if(n&&(r=n.getAttribute("src")||n.getAttribute("data-src")||n.getAttribute("data-lazy-src")),!r){const e=/https?:\/\/[^\s"'<>]*\.(?:jpg|jpeg|png|gif|webp)(?:\?[^\s"'<>]*)?/gi,n=t.match(e);if(n&&n.length>0){for(let e of n)if(!e.includes("thumbnail")&&!e.includes("avatar")&&!e.includes("icon")&&(e.includes("large")||e.includes("medium")||!e.includes("small"))){r=e;break}r||(r=n[0])}}}if(r){if(r=r.trim(),r.startsWith("/")){const t=e.querySelector("link")?.textContent?.trim();if(t)try{r=new URL(t).origin+r}catch(e){r=null}}if(r&&(r.startsWith("http")||r.startsWith("//"))&&(r.includes(".jpg")||r.includes(".jpeg")||r.includes(".png")||r.includes(".gif")||r.includes(".webp")||r.includes("image")))return r}}catch(e){}return null}function fixTextEncoding(e){if(!e)return e;const t=document.createElement("div");t.innerHTML=e;let n=t.textContent||t.innerText||e;const r={"√É¬©":"√©","√É¬°":"√°","√É ":"√†","√É¬≥":"√≥","√É¬≠":"√≠","√É¬∫":"√∫","√É¬±":"√±","√É¬ß":"√ß","√¢‚Ç¨‚Ñ¢":"'","√¢‚Ç¨≈ì":'"',"√¢‚Ç¨":'"','√¢‚Ç¨"':"‚Äî",'√¢‚Ç¨"':"‚Äì","√¢‚Ç¨¬¢":"‚Ä¢","√¢‚Ç¨¬≤":"‚Ä≤","√¢‚Ç¨¬≥":"‚Ä≥","√Ç":" ","√¢s":"'s","√¢ve":"'ve","√¢re":"'re","√¢ll":"'ll","√¢t":"'t","√¢d":"'d","√¢m":"'m","√¢":"'","√Ç¬¥":"'","√Ç`":"'","‚Äò":"'","‚Äô":"'","‚Äú":'"',"‚Äù":'"',"‚Äì":"-","‚Äî":"--","‚Ä¶":"..."};for(let[e,t]of Object.entries(r))n=n.replace(new RegExp(e,"g"),t);return n}function getPlaceholderImage(){return"images/icon-96x96.png"}function cleanDescription(e){if(!e)return"";e=fixTextEncoding(e);const t=document.createElement("div");t.innerHTML=e;let n=t.textContent||t.innerText||"";return n.length>200&&(n=n.substring(0,200)+"..."),n}function getISODate(e){if(!e)return"";try{const t=new Date(e);return isNaN(t.getTime())?"":t.toISOString()}catch(e){return""}}function formatDate(e){if(!e)return"";try{const t=new Date(e);if(isNaN(t.getTime()))return e;const n=new Date-t,r=Math.floor(n/36e5),o=Math.floor(r/24);return r<1?"Just now":r<24?`${r} hour${1!==r?"s":""} ago`:o<7?`${o} day${1!==o?"s":""} ago`:t.toLocaleDateString()}catch(t){return e}}function renderNewsSource(e){const{source:t,articles:n,error:r}=e,o=document.createElement("section");let i=`\n        <div class="source-header">\n            <h2 class="source-name">\n                <a href="${t.homepage}" target="_blank" style="color: ${t.color}; text-decoration: none;">\n                    ${t.name}\n                </a>\n            </h2>\n        </div>\n    `;return r?i+=`\n            <div class="error-message">\n                ‚ö†Ô∏è Error loading news: ${r}\n            </div>\n        `:0===n.length?i+='\n            <div class="error-message">\n                üì∞ No articles found\n            </div>\n        ':(i+='<div class="articles">',n.forEach(e=>{const t=e.imageUrl||getPlaceholderImage(),n=!e.imageUrl;i+=`\n                <article>\n                    <img src="${t}" alt="${n?"Nintendo News placeholder":""}" class="article-image${n?" placeholder-image":""}" loading="lazy" referrerpolicy="no-referrer" onerror="this.src='images/icon-96x96.png'; this.onerror=null;">\n                    <div class="article-content">\n                        <h3 class="article-title">\n                            <a href="${e.link}" target="_blank">\n                                ${e.title}\n                            </a>\n                        </h3>\n                        <div class="article-meta">\n                            <time class="article-date" datetime="${getISODate(e.rawDate)}">${e.pubDate}</time>\n                        </div>\n                        ${e.description?`<div class="article-description">${e.description}</div>`:""}\n                    </div>\n                </article>\n            `}),i+="</div>"),o.innerHTML=i,o}async function loadNews(){const e=document.getElementById("loading"),t=document.getElementById("news-container");t.innerHTML="";try{newsSources.forEach(e=>{const n=document.createElement("section");n.className="news-source loading-placeholder",n.innerHTML=`\n                <div class="source-header">\n                    <h2 class="source-name">\n                        <a href="${e.homepage}" target="_blank" style="color: ${e.color}; text-decoration: none;">\n                            ${e.name}\n                        </a>\n                    </h2>\n                    <div class="loading-spinner">‚è≥ Loading...</div>\n                </div>\n                <div class="articles-placeholder">\n                    <div style="height: 320px; display: flex; align-items: center; justify-content: center; color: #888;">\n                        <span class="loading-spinner">Loading articles...</span>\n                    </div>\n                </div>\n            `,n.id=`source-${e.name.replace(/\s+/g,"-").toLowerCase()}`,t.appendChild(n)});const e=newsSources.map(async(e,t)=>{try{const t=await Promise.race([fetchRSSFeed(e),new Promise((e,t)=>setTimeout(()=>t(new Error("Individual timeout")),15e3))]),n=document.getElementById(`source-${e.name.replace(/\s+/g,"-").toLowerCase()}`);if(n){const e=n.querySelector(".articles-placeholder"),r=n.querySelector(".loading-spinner");r&&r.remove(),n.className="news-source";let o='<div class="articles">';t.articles&&t.articles.length>0?t.articles.forEach(e=>{const t=e.imageUrl||getPlaceholderImage(),n=!e.imageUrl;o+=`\n                                <article>\n                                    <img src="${t}" alt="${n?"Nintendo News placeholder":""}" class="article-image${n?" placeholder-image":""}" loading="lazy" width="80" height="80" referrerpolicy="no-referrer" onerror="this.src='images/icon-96x96.png'; this.onerror=null;">\n                                    <div class="article-content">\n                                        <h3 class="article-title">\n                                            <a href="${e.link}" target="_blank">\n                                                ${e.title}\n                                            </a>\n                                        </h3>\n                                        <div class="article-meta">\n                                            <time class="article-date" datetime="${getISODate(e.rawDate)}">${e.pubDate}</time>\n                                        </div>\n                                        ${e.description?`<div class="article-description">${e.description}</div>`:""}\n                                    </div>\n                                </article>\n                            `}):o+='<div class="error-message">üì∞ No articles found</div>',o+="</div>",e&&(e.innerHTML=o)}return t}catch(t){const n=document.getElementById(`source-${e.name.replace(/\s+/g,"-").toLowerCase()}`);if(n){const e=n.querySelector(".articles-placeholder"),r=n.querySelector(".loading-spinner");r&&r.remove(),n.className="news-source",e&&(e.innerHTML=`\n                            <div class="error-message">\n                                ‚ö†Ô∏è Failed to load articles: ${t.message}\n                            </div>\n                        `)}return{source:e,articles:[],error:t.message}}});await Promise.allSettled(e)}catch(n){e.style.display="none",t.innerHTML='\n            <div class="error-message">\n                ‚ö†Ô∏è Failed to load news. Please check your internet connection and try again.\n            </div>\n        '}}let deferredPrompt,installButton;function showInstallButton(){installButton||(installButton=document.createElement("button"),installButton.textContent="üì± Install App",installButton.className="install-button",installButton.onclick=installPWA,document.querySelector("header").appendChild(installButton))}function hideInstallButton(){installButton&&(installButton.remove(),installButton=null)}async function installPWA(){if(deferredPrompt){deferredPrompt.prompt();const{outcome:e}=await deferredPrompt.userChoice;deferredPrompt=null,hideInstallButton()}}function initializeApp(){"requestIdleCallback"in window&&requestIdleCallback(()=>{setTimeout(()=>{navigator.onLine},2e3),scheduleCacheCleanup()}),loadNews()}function scheduleCacheCleanup(){"serviceWorker"in navigator&&navigator.serviceWorker.controller&&(setInterval(()=>{navigator.serviceWorker.controller.postMessage({type:"CLEAN_CACHE"})},36e5),setTimeout(()=>{navigator.serviceWorker.controller.postMessage({type:"CLEAN_CACHE"})},3e5))}function reportCachePerformance(){"performance"in window&&"getEntriesByType"in performance&&performance.getEntriesByType("resource").filter(e=>0===e.transferSize&&e.decodedBodySize>0)}window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e,showInstallButton()}),window.addEventListener("appinstalled",()=>{hideInstallButton(),deferredPrompt=null}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeApp):initializeApp(),window.addEventListener("load",()=>{setTimeout(reportCachePerformance,2e3)});